<!DOCTYPE html>
<html>
<head lang='en'>
    <meta charset='UTF-8'>
    <title>Homework 3 - MyWorld Data</title>

    <!-- ADD Libraries-->
    <script src='libs/d3/d3.min.js' charset='utf-8'></script>
    <script src='libs/jquery/jquery-2.1.1.min.js' charset='utf-8'></script>
    <script src='libs/bootstrap/js/bootstrap.min.js' charset='utf-8'></script>
    <script src='libs/queue/queue.min.js' charset='utf-8'></script>


    <!--Stylesheets-->
    <link rel='stylesheet' type='text/css' href='libs/bootstrap/css/bootstrap.min.css'>

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>


    <!-- FROM HERE ON IT IS HW3 stuff -->

    <!-- add own vis classes-->
    <script src = 'js/priovis.js'></script>
    <script src = 'js/agevis.js'></script>
    <script src = 'js/countvis.js'></script>

    <!-- add own stylesheet-->
    <link rel='stylesheet' type='text/css' href='css/myStyle.css'>

</head>
<body>
    <div class='container'>
        <h1>Homework 3 - MyWorld 2015 Data Visualization</h1>

        <div class='row'>
            <div class='col-md-8 col-sm-12'>
               <p> The following visualization shows you the votes for MyWorld 2015. You can select a time range to see changes in the distribution of votes und distribution of age of the voters.</p>
            </div>

        </div>

        <div class='row'>
            <div class='col-md-8'>
                <b>current brush:</b> <span id='brushInfo'></span>
            </div>
        </div>



        <div class='row'>
            <div class='col-md-9' id='countVis'>
            </div>
            <div class='col-md-3' id='ageVis'>
                <!-- TODO: delete placeholder svg element -->
                <svg width='230' height='330' style='background-color: lightcoral'>
                    <text x='50' y='50'>Age distribution: AgeViz</text>
                </svg>
            </div>
        </div>

        <div class='row'>
            <div class='col-md-12' id='prioVis'>
                <!-- TODO: delete placeholder svg element -->
                <svg width='650' height='440' style='background-color: lightgreen'>
                    <text x='50' y='50'>Distribution of priorities: PrioViz</text>
                </svg>
            </div>

        </div>






    </div>



    <script>
        $(function(){ // this function is called after the HTML document is fully loaded


            //==========================================
            //--- HERE IS WHERE ALL THE MAGIC STARTS --
            //==========================================


            // variables keeping global knowledge of the data
            var allData = [];
            var metaData = {};

            // this function can convert Date objects to a string
            // it can also convert strings to Date objects
            // see: https://github.com/mbostock/d3/wiki/Time-Formatting
            var dateFormatter = d3.time.format('%Y-%m-%d').parse;
            var dateParser = d3.time.format("%Y-%m-%d").parse


            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){

                //TODO: Create an eventHandler  --> DONE :)
                var MyEventHandler = new Object();


                //TODO: Instantiate all Vis Objects here
                var myPrio = new PrioViz( d3.select( '#prioVis' ), allData, metaData ),
                    myCount = new CountViz( d3.select( '#countVis' ), allData, metaData ),
                    myAge = new AgeViz( d3.select( '#ageVis' ), allData, metaData );

                // TODO: bind the eventHandler to the Vis Objects
                // events will be created from the CountVis object (nothing to do here)
                // events will be consumed by the PrioVis and AgeVis object (binding should happen here)

            }

            // call this function after both files are loaded -- error should be 'null' if no error
            var dataLoaded = function ( error, _allData, _metaData ) {

                if ( !error ) {

                    allData = _allData.map( function ( d ) {
                        var ageMap = d3.map( d.age, function( val ) {
                            return val.age;
                        });

                        var res = {
                            time: dateParser( d.day ),
                            count: parseInt( d[ 'count(*)' ] ),
                            prios: [],
                            ages: []
                        };

                        for ( i = 0; i < 16; i++ ) {
                            res.prios.push( d[ 'sum(p' + i + ')' ] );
                        }

                        res.ages = d3.range( 0, 100 ).map( function( age ) {
                            var count = ageMap.get( age );

                            if ( count ) {
                                return count[ 'count(*)' ];
                            } else {
                                return 0;
                            }

                        } );

                        return res;
                      }
                    )

                    metaData = _metaData;
                    initVis();
                }
            }

            var startHere = function(){
                queue()
                  .defer( d3.json, 'data/perDayData.json' )
                  .defer( d3.json, 'data/MYWorld_fields.json' )
                  .await( dataLoaded );

                // bind reset zoom button to a function (-- ONLY FOR BONUS --)
                d3.select( '#fitInBtn' ).on( 'click', function() {
                    // TODO: -- ONLY FOR BONUS --
                });


            }

            // from answer by Lukas Eder:
            // http://stackoverflow.com/questions/4413590/javascript-get-array-of-dates-between-2-dates
            Date.prototype.addDays = function( days ) {
                var dat = new Date(this.valueOf())
                dat.setDate(dat.getDate() + days);
                return dat;
            }

            // from answer by Lukas Eder:
            // http://stackoverflow.com/questions/4413590/javascript-get-array-of-dates-between-2-dates
            function getDates( startDate, stopDate ) {
                var dateArray = new Array();
                var currentDate = startDate;
                while (currentDate <= stopDate) {
                    dateArray.push( new Date (currentDate) )
                    currentDate = currentDate.addDays(1);
                }
                return dateArray;
            }

            startHere();
        })
    </script>
</body>
</html>
